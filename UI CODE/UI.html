<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>骨支架打印参数模拟器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        neutral: '#1F2937',
                        'neutral-light': '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-neutral">
    <div class="min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-calculator text-2xl"></i>
                        <h1 class="text-2xl md:text-3xl font-bold">骨支架打印参数模拟器</h1>
                    </div>
                    <div class="hidden md:block">
                        <p class="opacity-90">基于本地模型的打印参数反推工具</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- 左侧输入面板 -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl">
                        <h2 class="text-xl font-bold mb-6 text-primary flex items-center">
                            <i class="fa fa-sliders mr-2"></i>参数设置
                        </h2>

                        <form id="calculationForm" class="space-y-5">
                            <div>
                                <label for="model" class="block text-sm font-medium text-gray-700 mb-1">选择模型</label>
                                <select id="model" name="model" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                    {{ model_options }}
                                </select>
                            </div>

                            <div>
                                <label for="targetY" class="block text-sm font-medium text-gray-700 mb-1">目标y值</label>
                                <input type="number" id="targetY" name="targetY" step="0.01"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                                    placeholder="输入想要得到的机械模量(y值)" required>
                            </div>

                            <div>
                                <label for="tolerance" class="block text-sm font-medium text-gray-700 mb-1">误差容忍度</label>
                                <div class="flex items-center">
                                    <input type="number" id="tolerance" name="tolerance" step="0.01" min="0.01" max="100" value="10"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                    <span class="ml-2 text-gray-500">允许的误差范围</span>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center">
                                <i class="fa fa-search mr-2"></i>查找可能的打印参数
                            </button>
                        </form>

                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500 mb-3">使用说明</h3>
                            <ul class="text-sm text-gray-600 space-y-2">
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                    <span>选择一个模型，输入您想要的机械模量（y值）</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                    <span>设置误差容忍度，值越大找到的结果可能越多</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
                                    <span>系统会返回可能的参数范围：<br>
                                        - x1: 打印温度（180–250°C）<br>
                                        - x2: 打印速度（100–5100 mm/min）<br>
                                        - x3: 进给率（15–42%）<br>
                                        示例组合会显示具体数值及计算得到的 y 值
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 右侧结果展示区 -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl h-full">
                        <h2 class="text-xl font-bold mb-6 text-primary flex items-center">
                            <i class="fa fa-bar-chart mr-2"></i>计算结果
                        </h2>

                        <!-- 初始状态提示 -->
                        <div id="initialState" class="text-center py-16 text-gray-500">
                            <i class="fa fa-calculator text-5xl mb-4 opacity-30"></i>
                            <p>请在左侧输入参数并点击"查找可能的x值"按钮</p>
                        </div>

                        <!-- 加载状态 -->
                        <div id="loadingState" class="hidden text-center py-16">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
                            <p class="mt-4 text-gray-600">正在计算可能的x值范围...</p>
                        </div>

                        <!-- 错误状态 -->
                        <div id="errorState" class="hidden py-16">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                                <i class="fa fa-exclamation-circle text-red-500 text-3xl mb-2"></i>
                                <p id="errorMessage" class="text-red-600"></p>
                            </div>
                        </div>

                        <!-- 结果状态 -->
                        <div id="resultState" class="hidden space-y-6">
                            <!-- 结果摘要 -->
                            <div class="bg-neutral-light rounded-lg p-4">
                                <h3 class="font-medium text-gray-700 mb-2">结果摘要</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                                            <i class="fa fa-check text-primary"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">找到有效组合</p>
                                            <p id="resultCount" class="font-semibold"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center mr-3">
                                            <i class="fa fa-search text-accent"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">总采样点数</p>
                                            <p id="sampledCount" class="font-semibold"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- x值范围 -->
                            <div>
                                <h3 class="font-medium text-gray-700 mb-4">x值可能范围</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- x1范围 -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium text-primary">x1</span>
                                            <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full">范围</span>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最小值:</span>
                                                <span id="x1Min" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最大值:</span>
                                                <span id="x1Max" class="font-medium"></span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                <div id="x1Bar" class="bg-primary h-2 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- x2范围 -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium text-secondary">x2</span>
                                            <span class="text-xs bg-secondary/10 text-secondary px-2 py-1 rounded-full">范围</span>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最小值:</span>
                                                <span id="x2Min" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最大值:</span>
                                                <span id="x2Max" class="font-medium"></span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                <div id="x2Bar" class="bg-secondary h-2 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- x3范围 -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium text-accent">x3</span>
                                            <span class="text-xs bg-accent/10 text-accent px-2 py-1 rounded-full">范围</span>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最小值:</span>
                                                <span id="x3Min" class="font-medium"></span>
                                            </div>
                                            <div class="flex justify-between text-sm">
                                                <span class="text-gray-500">最大值:</span>
                                                <span id="x3Max" class="font-medium"></span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                                <div id="x3Bar" class="bg-accent h-2 rounded-full" style="width: 100%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 示例组合 -->
                            <div>
                                <h3 class="font-medium text-gray-700 mb-4">示例组合 (x1, x2, x3)</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead>
                                            <tr>
                                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">x1: printing_temperature</th>
                                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">x2: printing_speed</th>
                                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">x3: feed_rate</th>
                                                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">预计机械模量</th>
                                            </tr>
                                        </thead>
                                        <tbody id="examplesTable" class="bg-white divide-y divide-gray-200">
                                            <!-- 示例行会通过JavaScript动态添加 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 可视化图表 -->
                            <div>
                                <h3 class="font-medium text-gray-700 mb-4">x值分布</h3>
                                <div class="h-64">
                                    <canvas id="xValuesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-neutral text-white py-6">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-sm opacity-80">© 2023 y值反推x值计算器 - 本地模型计算工具</p>
                    <div class="mt-4 md:mt-0 flex space-x-4">
                        <a href="#" class="text-sm opacity-80 hover:opacity-100 transition-colors">使用帮助</a>
                        <a href="#" class="text-sm opacity-80 hover:opacity-100 transition-colors">关于模型</a>
                        <a href="#" class="text-sm opacity-80 hover:opacity-100 transition-colors">联系我们</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // 全局变量
        let xValuesChart = null;

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('calculationForm');

            // 表单提交事件
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                calculatePossibleXValues();
            });
        });

        // 计算可能的x值范围
        function calculatePossibleXValues() {
            // 获取表单数据
            const targetY = parseFloat(document.getElementById('targetY').value);
            const model = document.getElementById('model').value;
            const tolerance = parseFloat(document.getElementById('tolerance').value);

            // 显示加载状态
            showState('loadingState');

            // 发送请求到后端
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    target_y: targetY,
                    model: model,
                    tolerance: tolerance
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }

                if (data.found) {
                    displayResults(data);
                } else {
                    showError(data.message);
                }
            })
            .catch(error => {
                showError('计算过程中发生错误: ' + error.message);
            });
        }

        // 显示指定的状态区域
        function showState(stateId) {
            document.getElementById('initialState').classList.add('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('resultState').classList.add('hidden');

            document.getElementById(stateId).classList.remove('hidden');
        }

        // 显示错误信息
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showState('errorState');
        }

        // 显示计算结果
        function displayResults(data) {
            // 更新结果摘要
            document.getElementById('resultCount').textContent = data.total_points;
            document.getElementById('sampledCount').textContent = data.sampled_points;

            // 更新x值范围
            document.getElementById('x1Min').textContent = data.ranges.x1.min;
            document.getElementById('x1Max').textContent = data.ranges.x1.max;
            document.getElementById('x2Min').textContent = data.ranges.x2.min;
            document.getElementById('x2Max').textContent = data.ranges.x2.max;
            document.getElementById('x3Min').textContent = data.ranges.x3.min;
            document.getElementById('x3Max').textContent = data.ranges.x3.max;

            // 更新示例组合表格
            const examplesTable = document.getElementById('examplesTable');
            examplesTable.innerHTML = '';

            data.examples.forEach(example => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${example.x1}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${example.x2}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${example.x3}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-900">${example.y}</td>
                `;
                examplesTable.appendChild(row);
            });

            // 更新图表
            updateChart(data);

            // 显示结果状态
            showState('resultState');
        }
        // 更新x值分布图表
        function updateChart(data) {
            const ctx = document.getElementById('xValuesChart').getContext('2d');

            // 确保canvas上下文被正确清理
            if (xValuesChart) {
                xValuesChart.destroy();
                // 额外添加清理步骤
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            }

            // 检查Chart.js是否支持boxplot类型，如果不支持则使用散点图替代
            if (!Chart.controllers.boxplot) {
                // 使用散点图作为替代
                xValuesChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: 'x1值范围',
                                data: [
                                    {x: 1, y: data.ranges.x1.min},
                                    {x: 1, y: data.ranges.x1.max}
                                ],
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                pointRadius: 6
                            },
                            {
                                label: 'x2值范围',
                                data: [
                                    {x: 2, y: data.ranges.x2.min},
                                    {x: 2, y: data.ranges.x2.max}
                                ],
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                pointRadius: 6
                            },
                            {
                                label: 'x3值范围',
                                data: [
                                    {x: 3, y: data.ranges.x3.min},
                                    {x: 3, y: data.ranges.x3.max}
                                ],
                                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                                pointRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '变量'
                                },
                                ticks: {
                                    callback: function(value) {
                                        const labels = ['', 'x1', 'x2', 'x3'];
                                        return labels[value];
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '值'
                                }
                            }
                        }
                    }
                });
            } else {
                // 如果支持boxplot类型，则使用boxplot
                xValuesChart = new Chart(ctx, {
                    type: 'boxplot',
                    data: {
                        labels: ['x1', 'x2', 'x3'],
                        datasets: [{
                            label: 'x值分布',
                            data: [
                                [data.ranges.x1.min, data.ranges.x1.max],
                                [data.ranges.x2.min, data.ranges.x2.max],
                                [data.ranges.x3.min, data.ranges.x3.max]
                            ],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.2)',
                                'rgba(16, 185, 129, 0.2)',
                                'rgba(139, 92, 246, 0.2)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(139, 92, 246, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: '值'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const values = context.raw;
                                        return `${context.label}: ${values[0]} - ${values[1]}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>

</html>