<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dæ‰“å°éª¨æ”¯æ¶å‚æ•°ä¼˜åŒ–å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        .model-group { margin-bottom: 1rem; }
        .model-option { padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; }
        .model-disabled { background-color: #f8f9fa; color: #6c757d; cursor: not-allowed; }
        .model-enabled { background-color: #e3f2fd; cursor: pointer; }
        .model-enabled:hover { background-color: #cfe2ff; }
        .param-card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        .result-row-green { background-color: #d4edda !important; }
        .result-row-yellow { background-color: #fff3cd !important; }
        .img-container { text-align: center; margin: 2rem 0; }
        .img-container img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .loading { display: none; text-align: center; padding: 2rem; }
    </style>
</head>
<body class="container py-5">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <header class="text-center mb-5">
        <h1 class="text-primary">3Dæ‰“å°éª¨æ”¯æ¶å‚æ•°ä¼˜åŒ–å·¥å…·</h1>
        <p class="text-muted">åŸºäºFlaskä¸é›†æˆå­¦ä¹ çš„ä½ä»£ç å‚æ•°æ¨èç³»ç»Ÿ</p>
    </header>

    <!-- æ ¸å¿ƒåŠŸèƒ½åŒº -->
    <div class="row g-4">
        <!-- å·¦ä¾§ï¼šæ¨¡å‹é€‰æ‹©ä¸å‚æ•°è¾“å…¥ -->
        <div class="col-md-4">
            <!-- 1. æ¨¡å‹é€‰æ‹© -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">1. æ¨¡å‹é€‰æ‹©</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">æŒ‰ç±»å‹é€‰æ‹©æ¨¡å‹ï¼ˆè“è‰²ä¸ºå¯ä½¿ç”¨ï¼Œç°è‰²ä¸ºä¸å¯ç”¨ï¼‰</p>
                    <div class="overflow-y-auto" style="max-height: 350px;">
                        {% for model_type, models in models_meta.items() %}
                            <div class="model-group">
                                <h6 class="fw-bold">{{ model_type }}</h6>
                                {% for model in models %}
                                    <div class="model-option {% if model.loaded %}model-enabled{% else %}model-disabled{% endif %}"
                                         data-model-key="{{ model.key }}"
                                         {% if not model.loaded %}title="{{ model.error }}"{% endif %}>
                                        <div class="fw-semibold">{{ model.name }}</div>
                                        <div class="text-sm text-muted">{{ model.desc[:30] }}...</div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        <input type="hidden" id="selected-model-key" value="">
                    </div>

                </div>
            </div>

            <!-- 2. ç›®æ ‡æ€§èƒ½è¾“å…¥ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">2. ç›®æ ‡æ€§èƒ½è¾“å…¥</h5>
                </div>
                <div class="card-body">
                    <!-- å¼¹æ€§æ¨¡é‡èŒƒå›´ -->
                    <div class="mb-3">
                        <label class="form-label">ç›®æ ‡å¼¹æ€§æ¨¡é‡èŒƒå›´ï¼ˆ{{ target_e_cfg.desc }}ï¼‰</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" id="target-e-min" class="form-control"
                                       min="{{ target_e_cfg.min }}" max="{{ target_e_cfg.max }}"
                                       step="{{ target_e_cfg.step }}" value="275.00"
                                       placeholder="æœ€å°å€¼">
                                <div class="text-xs text-muted mt-1">ç²¾åº¦ï¼š{{ target_e_cfg.precision }}</div>
                            </div>
                            <div class="col-6">
                                <input type="number" id="target-e-max" class="form-control"
                                       min="{{ target_e_cfg.min }}" max="{{ target_e_cfg.max }}"
                                       step="{{ target_e_cfg.step }}" value="325.00"
                                       placeholder="æœ€å¤§å€¼">
                                <div class="text-xs text-muted mt-1">ç²¾åº¦ï¼š{{ target_e_cfg.precision }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- è¯¯å·®å®¹å¿åº¦ -->
                    <div class="mb-3">
                        <label class="form-label">è¯¯å·®å®¹å¿åº¦ï¼ˆ{{ tolerance_cfg.desc }}ï¼‰</label>
                        <input type="number" id="tolerance" class="form-control"
                               min="{{ tolerance_cfg.min }}" max="{{ tolerance_cfg.max }}"
                               step="{{ tolerance_cfg.step }}" value="{{ tolerance_cfg.default }}">
                        <div class="text-xs text-muted mt-1">ç²¾åº¦ï¼š{{ tolerance_cfg.precision }}ï¼Œé»˜è®¤ï¼š{{ tolerance_cfg.default }}</div>
                    </div>
                    <!-- æŸ¥è¯¢æŒ‰é’® -->
                    <button id="query-btn" class="btn btn-primary w-100" disabled>
                        ğŸ” ç”ŸæˆTop-10æ¨èå‚æ•°
                    </button>
                </div>
            </div>

            <!-- 3. æ¨¡å‹æ€§èƒ½å›æº¯ -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">3. æ¨¡å‹æ€§èƒ½å›æº¯</h5>
                </div>
                <div class="card-body" id="model-perf-container">
                    <p class="text-muted">è¯·é€‰æ‹©æ¨¡å‹ä»¥æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡</p>
                    <div id="model-perf-content" style="display: none;">
                        <div class="mb-2"><strong>æ¨¡å‹åç§°ï¼š</strong><span id="perf-name">-</span></div>
                        <div class="mb-2"><strong>ç²¾åº¦æŒ‡æ ‡ï¼š</strong><span id="perf-acc">-</span></div>
                        <div class="mb-2"><strong>è®¡ç®—é€Ÿåº¦ï¼š</strong><span id="perf-speed">-</span></div>
                        <div class="mb-2"><strong>é€‚ç”¨åœºæ™¯ï¼š</strong><span id="perf-desc">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºä¸å¯è§†åŒ– -->
        <div class="col-md-8">
            <!-- åŠ è½½ä¸­æç¤º -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">æ­£åœ¨ç­›é€‰æœ€ä¼˜å‚æ•°ç»„åˆ...ï¼ˆé¢„è®¡<1ç§’ï¼‰</p>
            </div>

            <!-- ç»“æœå®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰ -->
            <div id="result-container" style="display: none;">
                <!-- 1. ç»“æœç»Ÿè®¡ä¿¡æ¯ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">å‚æ•°ç­›é€‰ç»“æœç»Ÿè®¡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">ç›®æ ‡èŒƒå›´</h6>
                                        <p id="stat-target">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">ç¬¦åˆæ¡ä»¶æ ·æœ¬</h6>
                                        <p id="stat-total">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">æ¨èç»„æ•°</h6>
                                        <p>10ç»„ï¼ˆTop-10ï¼‰</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">è¯¯å·®æ ‡å‡†</h6>
                                        <p id="stat-tolerance">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Top-10å‚æ•°è¡¨æ ¼ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Top-10æ¨èæ‰“å°å‚æ•°ç»„åˆ</h5>
                        <div class="text-muted text-sm mt-1">
                            ç»¿è‰²ï¼šä¸ç›®æ ‡å·®å€¼â‰¤0.5MPaï¼Œé»„è‰²ï¼šå·®å€¼>0.5MPa
                        </div>
                    </div>
                    <div class="card-body overflow-x-auto">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr id="result-table-header">
                                    <th>æ’å</th>
                                    <!-- åŠ¨æ€æ·»åŠ ç‰¹å¾åˆ— -->
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- åŠ¨æ€æ·»åŠ ç»“æœè¡Œ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. å‚æ•°èŒƒå›´ç»Ÿè®¡å¡ç‰‡ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">æ¨èå‚æ•°èŒƒå›´ç»Ÿè®¡</h5>
                    </div>
                    <div class="card-body" id="param-stats-container">
                        <!-- åŠ¨æ€æ·»åŠ å‚æ•°ç»Ÿè®¡å¡ç‰‡ -->
                    </div>
                </div>

                <!-- 4. å¯è§†åŒ–å›¾è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">å¯è§†åŒ–åˆ†æ</h5>
                    </div>
                    <div class="card-body">
                        <!-- å¼¹æ€§æ¨¡é‡åˆ†å¸ƒ -->
                        <div class="img-container mb-4">
                            <h6>å¼¹æ€§æ¨¡é‡åˆ†å¸ƒå¯¹æ¯”å›¾</h6>
                            <div id="e-dist-placeholder" class="text-muted">
                                å±•ç¤ºå…¨é‡é¢„æµ‹åˆ†å¸ƒä¸ç¬¦åˆæ¡ä»¶åˆ†å¸ƒçš„å¯¹æ¯”
                            </div>
                            <img id="e-dist-img" src="" alt="å¼¹æ€§æ¨¡é‡åˆ†å¸ƒ" style="display: none;">
                        </div>
                        <!-- ç‰¹å¾é‡è¦æ€§ -->
                        <div class="img-container">
                            <h6>ç‰¹å¾é‡è¦æ€§åˆ†æå›¾ï¼ˆä»…RF/GA-RFæ¨¡å‹ï¼‰</h6>
                            <div id="fi-placeholder" class="text-muted">
                                å±•ç¤ºå„å‚æ•°å¯¹å¼¹æ€§æ¨¡é‡çš„å½±å“æƒé‡ï¼ˆè¿›ç»™ç‡ã€å®½åº¦ã€é«˜åº¦ä¸ºä¸»è¦å› ç´ ï¼‰
                            </div>
                            <img id="fi-img" src="" alt="ç‰¹å¾é‡è¦æ€§" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ— ç»“æœæç¤ºï¼ˆåˆå§‹éšè—ï¼‰ -->
            <div id="no-result" class="text-center py-5" style="display: none;">
                <div class="alert alert-warning" role="alert">
                    æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å‚æ•°ç»„åˆï¼Œè¯·å°è¯•è°ƒæ•´ç›®æ ‡èŒƒå›´æˆ–å¢å¤§è¯¯å·®å®¹å¿åº¦ï¼
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="text-center text-muted mt-5">
        <p>Â© 2024 3Dæ‰“å°éª¨æ”¯æ¶å‚æ•°ä¼˜åŒ–å·¥å…· | åŸºäºFlaskä¸é›†æˆå­¦ä¹ æ¡†æ¶</p>
    </footer>

    <!-- è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. æ¨¡å‹é€‰æ‹©é€»è¾‘
        $(document).on('click', '.model-enabled', function() {
            // ç§»é™¤å…¶ä»–æ¨¡å‹çš„é€‰ä¸­çŠ¶æ€
            $('.model-enabled').removeClass('bg-primary text-white');
            // æ·»åŠ å½“å‰æ¨¡å‹çš„é€‰ä¸­çŠ¶æ€
            $(this).addClass('bg-primary text-white');
            // è®°å½•é€‰ä¸­çš„æ¨¡å‹key
            const modelKey = $(this).data('model-key');
            $('#selected-model-key').val(modelKey);
            // å¯ç”¨æŸ¥è¯¢æŒ‰é’®
            $('#query-btn').prop('disabled', false);

            // åŠ è½½æ¨¡å‹æ€§èƒ½å›æº¯ä¿¡æ¯
            const modelsMeta = JSON.parse('{{ models_meta|tojson|safe }}');
            let modelMeta = null;
            for (const type in modelsMeta) {
                const models = modelsMeta[type];
                for (const m of models) {
                    if (m.key === modelKey) {
                        modelMeta = m;
                        break;
                    }
                }
                if (modelMeta) break;
            }
            if (modelMeta) {
                $('#model-perf-content').show();
                $('#perf-name').text(modelMeta.name);
                $('#perf-acc').text(modelMeta.acc);
                $('#perf-speed').text(modelMeta.speed);
                $('#perf-desc').text(modelMeta.desc);
            }
        });

        // 2. æŸ¥è¯¢å‚æ•°é€»è¾‘
        $('#query-btn').click(function() {
            const modelKey = $('#selected-model-key').val();
            const targetEmin = parseFloat($('#target-e-min').val());
            const targetEmax = parseFloat($('#target-e-max').val());
            const tolerance = parseFloat($('#tolerance').val());

            // æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œéšè—å…¶ä»–ç»“æœ
            $('#loading').show();
            $('#result-container').hide();
            $('#no-result').hide();

            // å‘é€APIè¯·æ±‚
            $.ajax({
                url: '/api/filter-params',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    model_key: modelKey,
                    target_E_min: targetEmin,
                    target_E_max: targetEmax,
                    tolerance: tolerance
                }),
                success: function(res) {
                    $('#loading').hide();
                    if (res.success) {
                        // æ˜¾ç¤ºç»“æœå®¹å™¨
                        $('#result-container').show();
                        // å¡«å……ç»Ÿè®¡ä¿¡æ¯
                        $('#stat-target').text(`${res.target_range.min.toFixed(2)}-${res.target_range.max.toFixed(2)}MPaï¼ˆå¹³å‡ï¼š${res.target_range.avg.toFixed(2)}MPaï¼‰`);
                        $('#stat-total').text(`${res.total_filtered}ç»„`);
                        $('#stat-tolerance').text(`${tolerance.toFixed(1)}MPa`);

                        // å¡«å……Top-10è¡¨æ ¼
                        const modelsMeta = JSON.parse('{{ models_meta|tojson|safe }}');
                        let modelMeta = null;
                        for (const type in modelsMeta) {
                            const models = modelsMeta[type];
                            for (const m of models) {
                                if (m.key === modelKey) {
                                    modelMeta = m;
                                    break;
                                }
                            }
                            if (modelMeta) break;
                        }
                        // åŠ¨æ€ç”Ÿæˆè¡¨å¤´
                        const headerRow = $('#result-table-header');
                        headerRow.empty();
                        headerRow.append('<th>æ’å</th>');
                        const features = modelMeta.features;
                        features.forEach(feat => {
                            const featDesc = modelMeta.feature_ranges[feat].desc;
                            headerRow.append(`<th>${featDesc}</th>`);
                        });
                        headerRow.append('<th>é¢„æµ‹å¼¹æ€§æ¨¡é‡ï¼ˆMPaï¼‰</th>');
                        headerRow.append('<th>ä¸ç›®æ ‡å·®å€¼ï¼ˆMPaï¼‰</th>');
                        // åŠ¨æ€ç”Ÿæˆè¡¨ä½“
                        const body = $('#result-table-body');
                        body.empty();
                        res.top10.forEach(item => {
                            const row = $(`<tr class="${item.E_diff <= 0.5 ? 'result-row-green' : 'result-row-yellow'}"></tr>`);
                            row.append(`<td>${item.rank}</td>`);
                            features.forEach(feat => {
                                row.append(`<td>${item[feat]}</td>`);
                            });
                            row.append(`<td>${item.pred_E.toFixed(2)}</td>`);
                            row.append(`<td>${item.E_diff.toFixed(2)}</td>`);
                            body.append(row);
                        });

                        // å¡«å……å‚æ•°ç»Ÿè®¡å¡ç‰‡
                        const statsContainer = $('#param-stats-container');
                        statsContainer.empty();
                        const paramStats = res.param_stats;
                        features.forEach(feat => {
                            const stat = paramStats[feat];
                            const card = $(`
                                <div class="col-md-4">
                                    <div class="card param-card">
                                        <div class="card-body">
                                            <h6 class="card-title">${stat.desc}</h6>
                                            <p>æœ€å°å€¼ï¼š${stat.min}</p>
                                            <p>æœ€å¤§å€¼ï¼š${stat.max}</p>
                                            <p>å¹³å‡å€¼ï¼š${stat.avg}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                            statsContainer.append(card);
                        });

                        // å¡«å……å¯è§†åŒ–å›¾è¡¨
                        if (res.e_dist_img) {
                            $('#e-dist-placeholder').hide();
                            $('#e-dist-img').attr('src', `data:image/png;base64,${res.e_dist_img}`).show();
                        } else {
                            $('#e-dist-img').hide();
                            $('#e-dist-placeholder').show();
                        }
                        if (res.fi_img) {
                            $('#fi-placeholder').hide();
                            $('#fi-img').attr('src', `data:image/png;base64,${res.fi_img}`).show();
                        } else {
                            $('#fi-img').hide();
                            $('#fi-placeholder').show();
                        }

                        // å¡«å……æ¨¡å‹æ€§èƒ½ä¿¡æ¯
                        $('#perf-name').text(res.model_perf.name);
                        $('#perf-acc').text(res.model_perf.acc);
                        $('#perf-speed').text(res.model_perf.speed);
                        $('#perf-desc').text(res.model_perf.desc);
                    } else {
                        // æ˜¾ç¤ºæ— ç»“æœ
                        $('#no-result').show();
                    }
                },
                error: function(xhr) {
                    $('#loading').hide();
                    const res = xhr.responseJSON || { msg: 'æœåŠ¡å™¨è¯·æ±‚å¤±è´¥' };
                    alert(`æŸ¥è¯¢å¤±è´¥ï¼š${res.msg}`);
                }
            });
        });

        // 3. è¾“å…¥åˆæ³•æ€§æ ¡éªŒ
        $('#target-e-min, #target-e-max, #tolerance').on('input', function() {
            const targetEmin = parseFloat($('#target-e-min').val()) || 0;
            const targetEmax = parseFloat($('#target-e-max').val()) || 0;
            const tolerance = parseFloat($('#tolerance').val()) || 0;
            const modelKey = $('#selected-model-key').val();

            // æ ¡éªŒå¼¹æ€§æ¨¡é‡èŒƒå›´
            const targetECfg = JSON.parse('{{ target_e_cfg|tojson|safe }}');
            let eValid = targetEmin >= targetECfg.min && targetEmax <= targetECfg.max && targetEmin < targetEmax;
            // æ ¡éªŒè¯¯å·®å®¹å¿åº¦
            const toleranceCfg = JSON.parse('{{ tolerance_cfg|tojson|safe }}');
            let tolValid = tolerance >= toleranceCfg.min && tolerance <= toleranceCfg.max;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            $('#query-btn').prop('disabled', !eValid || !tolValid || !modelKey);
        });
    </script>
</body>
</html>