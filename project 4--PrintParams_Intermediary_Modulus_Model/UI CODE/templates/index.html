<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printed Bone Scaffold Parameter Optimization Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <style>
        .model-group { margin-bottom: 1rem; }
        .model-option { padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; }
        .model-disabled { background-color: #f8f9fa; color: #6c757d; cursor: not-allowed; }
        .model-enabled { background-color: #e3f2fd; cursor: pointer; }
        .model-enabled:hover { background-color: #cfe2ff; }
        .param-card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1rem; }
        .result-row-green { background-color: #d4edda !important; }
        .result-row-yellow { background-color: #fff3cd !important; }
        .img-container { text-align: center; margin: 2rem 0; }
        .img-container img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .loading { display: none; text-align: center; padding: 2rem; }
    </style>
</head>
<body class="container py-5">
    <!-- Page Title -->
    <header class="text-center mb-5">
        <h1 class="text-primary">3D Printed Bone Scaffold Parameter Optimization Tool</h1>
        <p class="text-muted">Low-Code Parameter Recommendation System Based on Flask and Ensemble Learning</p>
    </header>

    <!-- Core Function Area -->
    <div class="row g-4">
        <!-- Left Side: Model Selection and Parameter Input -->
        <div class="col-md-4">
            <!-- 1. Model Selection -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">1. Model Selection</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Select model by type (blue for available, gray for unavailable)</p>
                    <div class="overflow-y-auto" style="max-height: 280px;">
                        {% for model_type, models in models_meta.items() %}
                            <div class="model-group">
                                <h6 class="fw-bold">{{ model_type }}</h6>
                                {% for model in models %}
                                    <div class="model-option {% if model.loaded %}model-enabled{% else %}model-disabled{% endif %}"
                                         data-model-key="{{ model.key }}"
                                         {% if not model.loaded %}title="{{ model.error }}"{% endif %}>
                                        <div class="fw-semibold">{{ model.name }}</div>
                                        <div class="text-sm text-muted">{{ model.desc[:30] }}...</div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        <input type="hidden" id="selected-model-key" value="">
                    </div>

                </div>
            </div>

            <!-- 2. Target Performance Input -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">2. Target Performance Input</h5>
                </div>
                <div class="card-body">
                    <!-- Elastic Modulus Range -->
                    <div class="mb-3">
                        <label class="form-label">Target Elastic Modulus Range ({{ target_e_cfg.desc }})</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" id="target-e-min" class="form-control"
                                       min="{{ target_e_cfg.min }}" max="{{ target_e_cfg.max }}"
                                       step="{{ target_e_cfg.step }}" value="275.00"
                                       placeholder="Minimum Value">
                                <div class="text-xs text-muted mt-1">Precision: {{ target_e_cfg.precision }}</div>
                            </div>
                            <div class="col-6">
                                <input type="number" id="target-e-max" class="form-control"
                                       min="{{ target_e_cfg.min }}" max="{{ target_e_cfg.max }}"
                                       step="{{ target_e_cfg.step }}" value="325.00"
                                       placeholder="Maximum Value">
                                <div class="text-xs text-muted mt-1">Precision: {{ target_e_cfg.precision }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- Tolerance -->
                    <div class="mb-3">
                        <label class="form-label">Error Tolerance ({{ tolerance_cfg.desc }})</label>
                        <input type="number" id="tolerance" class="form-control"
                               min="{{ tolerance_cfg.min }}" max="{{ tolerance_cfg.max }}"
                               step="{{ tolerance_cfg.step }}" value="{{ tolerance_cfg.default }}">
                        <div class="text-xs text-muted mt-1">Precision: {{ tolerance_cfg.precision }}, Default: {{ tolerance_cfg.default }}</div>
                    </div>
                    <!-- Query Button -->
                    <button id="query-btn" class="btn btn-primary w-100" disabled>
                        üîç Generate Top-10 Recommended Parameters
                    </button>
                </div>
            </div>

            <!-- 3. Model Performance Review -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">3. Model Performance Review</h5>
                </div>
                <div class="card-body" id="model-perf-container">
                    <p class="text-muted">Please select a model to view performance metrics</p>
                    <div id="model-perf-content" style="display: none;">
                        <div class="mb-2"><strong>Model Name:</strong><span id="perf-name">-</span></div>
                        <div class="mb-2"><strong>Accuracy Metric:</strong><span id="perf-acc">-</span></div>
                        <div class="mb-2"><strong>Computation Speed:</strong><span id="perf-speed">-</span></div>
                        <div class="mb-2"><strong>Applicable Scenarios:</strong><span id="perf-desc">-</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Result Display and Visualization -->
        <div class="col-md-8">
            <!-- Loading Prompt -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Filtering optimal parameter combinations... (Estimated <1 second)</p>
            </div>

            <!-- Result Container (Initially Hidden) -->
            <div id="result-container" style="display: none;">
                <!-- 1. Result Statistics -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Parameter Filtering Result Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Target Range</h6>
                                        <p id="stat-target">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Qualified Samples</h6>
                                        <p id="stat-total">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Recommended Groups</h6>
                                        <p>10 groups (Top-10)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card param-card bg-info text-white">
                                    <div class="card-body">
                                        <h6 class="card-title">Error Criterion</h6>
                                        <p id="stat-tolerance">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Top-10 Parameter Table -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Top-10 Recommended Printing Parameter Combinations</h5>
                        <div class="text-muted text-sm mt-1">
                            Green: Difference from target ‚â§0.5MPa, Yellow: Difference >0.5MPa
                        </div>
                    </div>
                    <div class="card-body overflow-x-auto">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr id="result-table-header">
                                    <th>Rank</th>
                                    <!-- Dynamically Add Feature Columns -->
                                </tr>
                            </thead>
                            <tbody id="result-table-body">
                                <!-- Dynamically Add Result Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. Parameter Range Statistics Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Recommended Parameter Range Statistics</h5>
                    </div>
                        <div class="overflow-x-auto" style="max-width: 100%;">
                            <div class="d-flex flex-nowrap" id="param-stats-container">
                                <!-- Dynamically Add Parameter Statistics Cards, d-flex flex-nowrap makes children arrange horizontally without wrapping -->
                            </div>
                        </div>
                </div>

                <!-- 4. Visualization Charts -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Visualization Analysis</h5>
                    </div>
                    <div class="card-body">
                        <!-- Elastic Modulus Distribution -->
                        <div class="img-container mb-4">
                            <h6>Elastic Modulus Distribution Comparison</h6>
                            <div id="e-dist-placeholder" class="text-muted">
                                Shows comparison between full prediction distribution and qualified distribution
                            </div>
                            <img id="e-dist-img" src="" alt="Elastic Modulus Distribution" style="display: none;">
                        </div>
                        <!-- Feature Importance -->
                        <div class="img-container">
                            <h6>Feature Importance Analysis (RF/GA-RF Models Only)</h6>
                            <div id="fi-placeholder" class="text-muted">
                                Shows the influence weight of each parameter on elastic modulus (feed rate, width, height are main factors)
                            </div>
                            <img id="fi-img" src="" alt="Feature Importance" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Result Prompt (Initially Hidden) -->
            <div id="no-result" class="text-center py-5" style="display: none;">
                <div class="alert alert-warning" role="alert">
                    No qualified parameter combinations found. Please try adjusting the target range or increasing the error tolerance!
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-muted mt-5">
        <p>¬© 2024 3D Printed Bone Scaffold Parameter Optimization Tool | Based on Flask and Ensemble Learning Framework</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. Model Selection Logic
        $(document).on('click', '.model-enabled', function() {
            // Remove selection status from other models
            $('.model-enabled').removeClass('bg-primary text-white');
            // Add selection status to current model
            $(this).addClass('bg-primary text-white');
            // Record selected model key
            const modelKey = $(this).data('model-key');
            $('#selected-model-key').val(modelKey);
            // Enable query button
            $('#query-btn').prop('disabled', false);

            // Load model performance review information
            const modelsMeta = JSON.parse('{{ models_meta|tojson|safe }}');
            let modelMeta = null;
            for (const type in modelsMeta) {
                const models = modelsMeta[type];
                for (const m of models) {
                    if (m.key === modelKey) {
                        modelMeta = m;
                        break;
                    }
                }
                if (modelMeta) break;
            }
            if (modelMeta) {
                $('#model-perf-content').show();
                $('#perf-name').text(modelMeta.name);
                $('#perf-acc').text(modelMeta.acc);
                $('#perf-speed').text(modelMeta.speed);
                $('#perf-desc').text(modelMeta.desc);
            }
        });

        // 2. Parameter Query Logic
        $('#query-btn').click(function() {
            const modelKey = $('#selected-model-key').val();
            const targetEmin = parseFloat($('#target-e-min').val());
            const targetEmax = parseFloat($('#target-e-max').val());
            const tolerance = parseFloat($('#tolerance').val());

            // Show loading, hide other results
            $('#loading').show();
            $('#result-container').hide();
            $('#no-result').hide();

            // Send API request
            $.ajax({
                url: '/api/filter-params',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    model_key: modelKey,
                    target_E_min: targetEmin,
                    target_E_max: targetEmax,
                    tolerance: tolerance
                }),
                success: function(res) {
                    console.log("Complete returned data:", res);
                    console.log("Success status:", res.success);
                    console.log("Top10 data length:", res.top10?.length);
                    $('#loading').hide();
                    if (res.success) {
                        // Show result container
                        $('#result-container').show();
                        // Fill statistical information
                        $('#stat-target').text(`${res.target_range.min.toFixed(2)}-${res.target_range.max.toFixed(2)}MPa (Average: ${res.target_range.avg.toFixed(2)}MPa)`);
                        $('#stat-total').text(`${res.total_filtered} groups`);
                        $('#stat-tolerance').text(`${tolerance.toFixed(1)}MPa`);

                        // Fill Top-10 table
                        const modelsMeta = JSON.parse('{{ models_meta|tojson|safe }}');
                        let modelMeta = null;
                        for (const type in modelsMeta) {
                            const models = modelsMeta[type];
                            for (const m of models) {
                                if (m.key === modelKey) {
                                    modelMeta = m;
                                    break;
                                }
                            }
                            if (modelMeta) break;
                        }
                        // Dynamically generate table header
                        const headerRow = $('#result-table-header');
                        headerRow.empty();
                        headerRow.append('<th>Rank</th>');
                        const features = modelMeta.features;
                        features.forEach(feat => {
                            const featDesc = modelMeta.feature_ranges[feat].desc;
                            headerRow.append(`<th>${featDesc}</th>`);
                        });
                        headerRow.append('<th>Predicted Elastic Modulus (MPa)</th>');
                        headerRow.append('<th>Difference from Target (MPa)</th>');
                        // Dynamically generate table body
                        const body = $('#result-table-body');
                        body.empty();
                        res.top10.forEach(item => {
                            const row = $(`<tr class="${item.E_diff <= 0.5 ? 'result-row-green' : 'result-row-yellow'}"></tr>`);
                            row.append(`<td>${item.rank}</td>`);
                            features.forEach(feat => {
                                row.append(`<td>${item[feat]}</td>`);
                            });
                            row.append(`<td>${item.pred_E.toFixed(2)}</td>`);
                            row.append(`<td>${item.E_diff.toFixed(2)}</td>`);
                            body.append(row);
                        });

                        // Fill parameter statistics cards
                        const statsContainer = $('#param-stats-container');
                        statsContainer.empty();
                        const paramStats = res.param_stats;
                        features.forEach(feat => {
                            const stat = paramStats[feat];
                            const card = $(`
                                <div class="col-md-4">
                                    <div class="card param-card">
                                        <div class="card-body">
                                            <h6 class="card-title">${stat.desc}</h6>
                                            <p>Minimum: ${stat.min}</p>
                                            <p>Maximum: ${stat.max}</p>
                                            <p>Average: ${stat.avg}</p>
                                        </div>
                                    </div>
                                </div>
                            `);
                            statsContainer.append(card);
                        });

                        // Fill visualization charts
                        if (res.e_dist_img) {
                            $('#e-dist-placeholder').hide();
                            $('#e-dist-img').attr('src', `data:image/png;base64,${res.e_dist_img}`).show();
                        } else {
                            $('#e-dist-img').hide();
                            $('#e-dist-placeholder').show();
                        }
                        if (res.fi_img) {
                            $('#fi-placeholder').hide();
                            $('#fi-img').attr('src', `data:image/png;base64,${res.fi_img}`).show();
                        } else {
                            $('#fi-img').hide();
                            $('#fi-placeholder').show();
                        }

                        // Fill model performance information
                        $('#perf-name').text(res.model_perf.name);
                        $('#perf-acc').text(res.model_perf.acc);
                        $('#perf-speed').text(res.model_perf.speed);
                        $('#perf-desc').text(res.model_perf.desc);
                    } else {
                        // Show no result
                        $('#no-result').show();
                    }
                },
                error: function(xhr) {
                    $('#loading').hide();
                    const res = xhr.responseJSON || { msg: 'Server request failed' };
                    alert(`Query failed: ${res.msg}`);
                }
            });
        });

        // 3. Input Validity Check
        $('#target-e-min, #target-e-max, #tolerance').on('input', function() {
            const targetEmin = parseFloat($('#target-e-min').val()) || 0;
            const targetEmax = parseFloat($('#target-e-max').val()) || 0;
            const tolerance = parseFloat($('#tolerance').val()) || 0;
            const modelKey = $('#selected-model-key').val();

            // Check elastic modulus range
            const targetECfg = JSON.parse('{{ target_e_cfg|tojson|safe }}');
            let eValid = targetEmin >= targetECfg.min && targetEmax <= targetECfg.max && targetEmin < targetEmax;
            // Check error tolerance
            const toleranceCfg = JSON.parse('{{ tolerance_cfg|tojson|safe }}');
            let tolValid = tolerance >= toleranceCfg.min && tolerance <= toleranceCfg.max;

            // Update button status
            $('#query-btn').prop('disabled', !eValid || !tolValid || !modelKey);
        });
    </script>
</body>
</html>